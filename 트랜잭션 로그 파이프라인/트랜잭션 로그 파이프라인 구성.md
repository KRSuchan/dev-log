# 트랜잭션 로그 파이프라인 구성

트랜잭션 로그를 EFS, EBS, Fluentd, Fluent Bit으로 로그 데이터를 안정적으로 저장하고 수집/전송하는 전체 파이프라인을 구성한다.

**1. 개념 정리**

EBS (Elastic Block Store) : EC2에 붙는 디스크(로컬 저장소). 빠르고 안정적, 하지만 EC2 인스턴스에 종속됨.

EFS (Elastic File System) : 여러 EC2가 동시에 접근 가능한 공유 네트워크 파일 시스템

Fluentd : 로그를 수집 → 가공 → 전달하는 오픈소스 로그 파이프라인. Ruby 기반

Fluent Bit : Fluentd의 경량 버전(C 기반). CPU/메모리 사용량이 적고 빠름.

**2. 각 요소의 실제 사용 위치**
```
[App 서버들]

    |- 로그 파일 (EBS에 저장)

    |- Fluent Bit (로컬 로그 수집 → 전송)

[중앙 로그 수집기]

    |- Fluentd (로그 집계, 필터링, 전송)

    |- EFS (여러 서버가 접근 가능한 공유 저장소)

[저장소 / 분석 시스템]

    ㄴ S3 / Elasticsearch / Cloudwatch / Loki / DB 등
```

**요약**

EBS : 각 서버의 1차 저장소 (로그 파일이 처음 기록됨)

Fluent Bit : 각 서버에서 로그를 읽어서 중앙으로 보냄

EFS : 여러 서버가 공유하는 중앙 로그 저장소로 활용 가능 (또는 백업용)

**3. 각 기술의 장단점**

| 항목 | 장점 | 단점 |
| -- | -- | -- |
| EBS | 빠른 IO 성능 (SSD 기반), EC2에 바로 붙음 | 인스턴스에 종속, 공유 불가 |
|EFS | 여러 서버에서 공유 가능, 무한 확장 | IO 지연이 있음, 비용 상대적으로 비쌈 |
| Fluentd | 플러그인 다양, 복잡한 파이프라인 구축 용이 | 무겁고 설정이 복잡 |
| Fluent Bit | 가볍고 빠름, 컨테이너 환경에 적합 | 고급 필터링 기능은 제한적

**4. 거래 로그 (트랜잭션 로그)에 대한 고려사항**

거래로그는 민감하고, 유실되면 안 되며, 실시간 분석이 필요한 경우가 많음.

따라서 다음 조건을 만족해야 합니다.

- 로그 유실 방지 (at-least-once 보장)
- 순서 보장 (특히 결제, 주문 로그 등)
- 재처리 가능 (에러 시 재전송)
- 보관/백업 가능 (법적 보관 의무가 있을 수도 있음)

**5. 추천 아키텍처**

A. 가장 일반적이고 안전한 방식

*EBS + Fluent Bit + Fluentd + S3(or DB)*

- 구조
```
[각 EC2 인스턴스]

    |- 거래 로그 → EBS 저장

    |- Fluent Bit → 중앙 Fluentd로 전송

[중앙 Fluentd 서버]

    |- 로그 수집/필터링

    |- 최종적으로 S3 또는 DB(예 : Elasticsearch, RDS)에 저장
```
이유

- EBS는 빠르기 때문에 앱 서버 로그 저장용으로 적합
- Fluent Bit은 경량이므로 앱 서버 리소스 부담이 적음
- Fluentd는 중앙에서 집계와 백업을 책임짐
- S3 같은 오브젝트 스토리지는 영구 보관 및 분석용으로 좋음

B. “EFS + Fluent Bit (단순 구조, 공유 로그 디렉토리 사용)”

구조

[여러 서버] → [EFS 공유 로그 디렉토리] → [분석/수집기]

장점

- 여러 서버가 같은 파일 시스템에 동시에 로그를 씀
- Fluent Bit이 한 곳(EFS)만 모니터링하면 됨
- 장애 시 로그 파일이 EFS에 남아있어 복구 쉬움

단점

- EFS는 NFS 기반이라 쓰기 부하(동시 IO)에 약함
- 거래 로그처럼 쓰기 빈도가 높은 경우 성능 저하 가능
- 초당 수천 건 이상이면 병목 가능

⇒ 그래서 **거래로그(고빈도 I/O)**에는 EBS 중심 구조가 더 안정적

**6. 결론 요약**

|항목|추천 여부|이유|
| -- | -- | -- |
| EBS | Good | 각 서버의 빠른 로그 쓰기용 |
| EFS | 보조용 | 공유 및 백업용으로만 사용 권장 |
| Fluent Bit | Good | 경량 로그 수집기로 서버 부담 최소 |
| Fluentd | Good | 중앙 로그 집계 및 가공 처리 |


**Tip**

```

- 거래 로그는 “EBS → Fluent Bit → Fluentd → S3(or DB)”로 흘러가는 구조가 가장 안전함.

- EFS는 장애 시 임시 로그 공유나 중앙 백업 디렉토리 용으로만 쓰는 게 좋음.

- Fluent Bit에서 버퍼링 + 재전송 옵션을 꼭 켜야 로그 유실이 안 됨

- Fluentd는 서버 2대 이상 구성해서 HA로 만드는 걸 권장 (로그 집계기 단일 장애 방지)

```