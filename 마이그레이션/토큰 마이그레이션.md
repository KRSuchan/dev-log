# 토큰 마이그레이션(JWT 기준)

### **- JWT의 구성**

~~~
header.payload.signature
~~~
- header: 토큰 타입(JWT) + 서명 알고리즘(예: HS256)
- payload: 사용자 정보(클레임, claims)
- signature: HMACSHA256(base64(header) + "." + base64(payload), secret_key)  → **JWT의 유효성** → 기존 토큰이 새 시스템에서도 유효한가

### **1. 기존 JWT 유효성 유지**

- 목적

    사용자들이 로그인 상태를 유지하고 싶을 때
    → 기존 JWT도 새 서버에서 검증되게 해야함.

1. 기존 서명키(signature key) 유지
    - JWT는 secret key가 같으면 어디서든 검증이 가능
    - 즉, 새 서버에서도 같은 secret key로 설정

2. 점진적 키 교체 전략 (Key Rotation) for 보안 강화
    
    : 기존 서명키와 새 서명키 보관 → 모든 키로 시도 → 새 토큰 발급 시 새 서명키 사용 (일정 시간 후 기존 서명키 삭제)

### **2. 기존 JWT 무효화**

- 목적

    보안 이슈 및 일괄 재로그인이 필요한 경우

1. 새 secret key로 교체 (기존 모든 secret key 모두 invalid)
2. 로그인 시 401 Unauthorized 반환
3. 클라이언트 재로그인 유도(UX 저하 주의)

### **3. 절차 예시**

| 단계                     | 내용                                                   |
| ---------------------- | ---------------------------------------------------- |
| **1. 키 관리 이관** | 기존 `.env` 또는 Secret Manager에 있던 JWT_SECRET을 새 환경에 등록|
| **2. 동일 검증 로직 배포** | 새 서버에서도 동일한 `jwt.verify(token, secret)` 로직 사용|
| **3. 점진적 키 교체 (선택)** | SECRET_OLD → SECRET_NEW 구조 적용|
| **4. 스테이징 테스트** | 기존 JWT가 새 서버에서 인증되는지 확인|
| **5. 실제 전환 (Cutover)** | 로그인 발급은 새 서버에서만 수행|
| **6. 일정 기간 후 정리** | SECRET_OLD 제거 및 DB에서 만료된 토큰 삭제|

### **4. 추가 고려 사항**

| 항목                              | 설명                                                   |
| ------------------------------- | ---------------------------------------------------- |
| **Refresh Token**               | Access Token보다 수명이 길기 때문에, 반드시 함께 마이그레이션하거나 만료 처리 필요 |
| **토큰 저장소 (Blacklist, Redis 등)** | 만료 토큰 리스트나 세션 DB를 쓰는 경우, 데이터 이전 필요                   |
| **발급 도메인 변경 시**                 | JWT의 `aud`, `iss` 값이 달라지면 검증 실패 가능 → 새 값 반영 필요       |
| **배포 타이밍**                      | 모든 인증 서버가 동시에 secret key를 갱신하도록 조정해야 혼선 없음           |

